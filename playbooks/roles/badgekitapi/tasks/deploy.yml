---
- name: add repository for up-to-date nodejs
  apt_repository: repo='ppa:chris-lea/node.js' state=present

- name: update nodejs package
  apt: update_cache=yes
  apt: name=nodejs state=latest

- name: checkout badgekitapi into {{ badgekitapi_app_dir }}
  git: >
    dest={{ badgekitapi_app_dir }} repo={{ badgekitapi_repo }}
    version=master

- name: install nodejs dependencies
  npm: path={{ badgekitapi_app_dir }}

- name: add mysql db {{ badgekitapi_env.DB_NAME }}
  mysql_db: db={{ badgekitapi_env.DB_NAME }} state=present encoding=utf8

- name: create mysql user {{ badgekitapi_env.DB_USER }}
  mysql_user: >
    name={{ badgekitapi_env.DB_USER }}
    password={{ badgekitapi_env.DB_PASSWORD }}
    priv='{{ badgekitapi_env.DB_NAME }}.*:ALL'

- name: run badgekitapi db migrations
  environment: badgekitapi_env
  shell: >
    ./bin/db-migrate up
      chdir={{ badgekitapi_app_dir }}

- name: create log directory
  file: >
    dest="{{ badgekitapi_log_dir }}"
    mode=755
    owner={{ badgekitapi_user }}
    state=directory

- name: write supervisord config for badgekitapi
  template: >
    src=badgekitapi.conf.j2
    dest="{{ supervisor_available_dir }}/badgekitapi.conf"
  sudo_user: "{{ supervisor_user }}"

- name: enable supervisord config for badgekitapi
  file: >
    src="{{ supervisor_available_dir }}/badgekitapi.conf"
    dest="{{ supervisor_cfg_dir }}/badgekitapi.conf"
    state=link
    force=yes
  sudo_user: "{{ supervisor_user }}"
  changed_when: true
  notify: restart badgekitapi
